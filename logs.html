<body>
  <div class="container">
    <h2>üìä Tasktel MS - Logs & Current Stock</h2>
    
    <div class="section">
      <h3>üì¶ Current Stock</h3>
      <div class="stock-controls">
        <input type="text" id="stockSearch" placeholder="Search by Product Name..." title="Search current stock" />
      </div>
      <div class="stock-container" id="stockContainer">
        </div>
    </div>
    
    <div class="section">
      <h3>üìã Transaction History</h3>
      <div class="controls">
        <input type="date" id="logDate" title="Filter by date" />
        <input type="text" id="searchBox" placeholder="Search Name, Person, DC, Serial..." title="Search in logs" />
        <button onclick="filterLogs()">üîç Search Logs</button>
        <button onclick="goBack()" class="back-btn">üîô Back to Dashboard</button>
      </div>
      <div class="table-container">
        <table>
          <thead>
            <tr>
              <th>Type</th>
              <th>Product Name</th>
              <th>Qty</th>
              <th>Person</th>
              <th>Date</th>
              <th>DC No.</th>
              <th>Serial No.</th>
              <th>Customer Name & Address</th>
              <th>Timestamp</th>
            </tr>
          </thead>
          <tbody id="logsBody">
            </tbody>
        </table>
      </div>
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <script src="firebase-config.js"></script>
  
  <script>
    const logsBody = document.getElementById("logsBody");
    const stockContainer = document.getElementById("stockContainer");
    let allLogs = [];
    let allStock = [];

    window.onload = () => {
      if (typeof firebase === 'undefined') {
        alert("Firebase not loaded!");
        return;
      }
      loadCurrentStock();
      loadAllLogs();
    };
    
    // Load and display current stock
    function loadCurrentStock() {
      firebase.database().ref("products").orderByKey().once("value", snapshot => {
        allStock = [];
        if (snapshot.exists()) {
          snapshot.forEach(child => {
            allStock.push({ name: child.key, quantity: child.val().quantity });
          });
        }
        displayStock(allStock);
        document.getElementById('stockSearch').addEventListener('input', () => displayStock(allStock));
      });
    }

    function displayStock(stockData) {
      const searchTerm = document.getElementById('stockSearch').value.toLowerCase();
      const filteredStock = stockData.filter(item => item.name.toLowerCase().includes(searchTerm));
      
      if (filteredStock.length === 0) {
        stockContainer.innerHTML = '<div class="stock-empty-state">No stock items found.</div>';
        return;
      }
      
      let stockHTML = '';
      filteredStock.forEach(item => {
        let quantityClass = item.quantity <= 5 ? 'stock-quantity low' : 'stock-quantity';
        if (item.quantity === 0) quantityClass = 'stock-quantity critical';

        stockHTML += `
          <div class="stock-item">
            <div class="stock-details">
              <div class="stock-name">${item.name}</div>
            </div>
            <div class="${quantityClass}">${item.quantity}</div>
          </div>
        `;
      });
      stockContainer.innerHTML = stockHTML;
    }

    // Load and display transaction logs
    function loadAllLogs() {
      firebase.database().ref("logs").once("value", snapshot => {
        allLogs = [];
        if (snapshot.exists()) {
          snapshot.forEach(child => {
            allLogs.push(child.val());
          });
        }
        // Sort newest first
        allLogs.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
        displayLogs(allLogs);
      });
    }

    function filterLogs() {
        const selectedDate = document.getElementById("logDate").value;
        const searchTerm = document.getElementById("searchBox").value.toLowerCase().trim();
        
        let filtered = allLogs.filter(log => {
            const dateMatch = !selectedDate || log.date === selectedDate;
            const searchMatch = !searchTerm ||
                (log.name && log.name.toLowerCase().includes(searchTerm)) ||
                (log.person && log.person.toLowerCase().includes(searchTerm)) ||
                (log.dcNo && log.dcNo.toLowerCase().includes(searchTerm)) ||
                (log.serialNumber && log.serialNumber.toLowerCase().includes(searchTerm)) ||
                (log.customerDetails && log.customerDetails.toLowerCase().includes(searchTerm));
            
            return dateMatch && searchMatch;
        });
        
        displayLogs(filtered);
    }

    function displayLogs(logs) {
      if (logs.length === 0) {
        logsBody.innerHTML = '<tr><td colspan="9" class="empty-state">No logs found matching criteria.</td></tr>';
        return;
      }
      
      let logsHTML = '';
      logs.forEach(log => {
        let badgeClass = 'badge-inward';
        if (log.type === 'OUTWARD') badgeClass = 'badge-outward';
        if (log.type === 'DELETE') badgeClass = 'badge-delete';

        logsHTML += `
          <tr>
            <td><span class="badge ${badgeClass}">${log.type}</span></td>
            <td><strong>${log.name || '-'}</strong></td>
            <td><strong>${log.quantity || '-'}</strong></td>
            <td>${log.person || '-'}</td>
            <td class="date-cell">${log.date || '-'}</td>
            <td>${log.dcNo || '-'}</td>
            <td>${log.serialNumber || '-'}</td>
            <td class="comment-cell">${log.customerDetails || '-'}</td>
            <td class="date-cell">${log.timestamp || '-'}</td>
          </tr>
        `;
      });
      logsBody.innerHTML = logsHTML;
    }

    function goBack() {
      window.location.href = "index.html";
    }
  </script>
</body>
